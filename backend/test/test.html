<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI Legal Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui; }

body {
  display: flex;
  height: 100vh;
  background: #f7f7f8;
}

/* ---------- SIDEBAR ---------- */
#sidebar {
  width: 280px;
  background: #202123;
  color: white;
  display: flex;
  flex-direction: column;
}

#sidebar header {
  padding: 16px;
  border-bottom: 1px solid #333;
}

button {
  padding: 10px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

#newThreadBtn, #logoutBtn {
  width: 100%;
  background: #343541;
  color: white;
  margin-bottom: 8px;
}

#threads {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.thread {
  padding: 10px;
  background: #2a2b32;
  border-radius: 6px;
  margin-bottom: 6px;
  cursor: pointer;
}

/* ---------- CHAT ---------- */
#chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.message {
  max-width: 800px;
  margin: 0 auto 20px auto;
}

.message.user { text-align: right; }

.bubble {
  display: inline-block;
  padding: 14px 18px;
  border-radius: 12px;
}

.user .bubble {
  background: #007aff;
  color: white;
}

.ai .bubble {
  background: #e5e5ea;
}

/* ---------- INPUT ---------- */
#inputBar {
  padding: 16px;
  border-top: 1px solid #ddd;
  background: white;
}

#chatForm {
  display: flex;
  gap: 10px;
}

#input {
  flex: 1;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

/* ---------- AUTH MODAL ---------- */
#authModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
}

#authBox {
  background: white;
  padding: 24px;
  width: 320px;
  border-radius: 12px;
}

#authBox input {
  width: 100%;
  padding: 10px;
  margin-bottom: 12px;
}

.switch {
  text-align: center;
  color: #007aff;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- ========== AUTH MODAL ========== -->
<div id="authModal">
  <div id="authBox">
    <h2 id="authTitle">Login</h2>
    <input id="username" placeholder="Username" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="submitAuth()">Submit</button>
    <div class="switch" onclick="toggleAuth()">Switch to Register</div>
  </div>
</div>

<!-- ========== SIDEBAR ========== -->
<div id="sidebar">
  <header>
    <button id="newThreadBtn">＋ New Chat</button>
    <button id="logoutBtn">Logout</button>
  </header>
  <div id="threads"></div>
</div>

<!-- ========== CHAT ========== -->
<div id="chat">
  <div id="messages"></div>
  <div id="inputBar">
    <form id="chatForm">
      <input id="input" placeholder="Ask a legal question…" />
      <button>Send</button>
    </form>
  </div>
</div>

<script>
const API = "http://localhost:8000";
let token = localStorage.getItem("token");
let currentThread = null;
let authMode = "login";

/* ---------- AUTH ---------- */
function showAuth() {
  document.getElementById("authModal").style.display = "flex";
}

function toggleAuth() {
  authMode = authMode === "login" ? "register" : "login";
  document.getElementById("authTitle").innerText =
    authMode === "login" ? "Login" : "Register";
}

async function submitAuth() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const res = await fetch(`${API}/auth/${authMode}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();

  if (data.access_token) {
    token = data.access_token;
    localStorage.setItem("token", token);
    document.getElementById("authModal").style.display = "none";
    loadThreads();
  } else {
    alert("Authentication failed");
  }
}

function logout() {
  localStorage.removeItem("token");
  location.reload();
}

/* ---------- HELPERS ---------- */
function headers() {
  return {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${token}`
  };
}

function addMessage(role, text) {
  const div = document.createElement("div");
  div.className = `message ${role}`;
  div.innerHTML = `<div class="bubble">${text}</div>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

/* ---------- CHAT ---------- */
async function loadThreads() {
  const res = await fetch(`${API}/chat/threads`, { headers: headers() });
  const threads = await res.json();
  threadsDiv.innerHTML = "";

  threads.forEach(t => {
    const d = document.createElement("div");
    d.className = "thread";
    d.innerText = t.title || "Chat";
    d.onclick = () => selectThread(t.id);
    threadsDiv.appendChild(d);
  });
}

async function selectThread(id) {
  currentThread = id;
  messages.innerHTML = "";

  const res = await fetch(`${API}/chat/threads/${id}`, { headers: headers() });
  const data = await res.json();

  data.messages.forEach(m =>
    addMessage(m.role === "human" ? "user" : "ai", m.content)
  );
}

async function sendMessage(text) {
  addMessage("user", text);

  const res = await fetch(`${API}/chat/threads/${currentThread}/messages`, {
    method: "POST",
    headers: headers(),
    body: JSON.stringify({ content: text })
  });

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let aiText = "";

  addMessage("ai", "");

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    aiText += decoder.decode(value);
    messages.lastChild.querySelector(".bubble").innerText = aiText;
  }
}

/* ---------- EVENTS ---------- */
newThreadBtn.onclick = async () => {
  const res = await fetch(`${API}/chat/threads`, {
    method: "POST",
    headers: headers(),
    body: JSON.stringify({ title: "New Chat" })
  });
  const t = await res.json();
  loadThreads();
  selectThread(t.id);
};

logoutBtn.onclick = logout;

chatForm.onsubmit = e => {
  e.preventDefault();
  if (!currentThread) return;
  const text = input.value.trim();
  if (!text) return;
  input.value = "";
  sendMessage(text);
};

/* ---------- INIT ---------- */
if (!token) showAuth();
else loadThreads();
</script>

</body>
</html>
